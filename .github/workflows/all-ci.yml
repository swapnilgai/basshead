name: Basshead CI (Free Tier Optimized)

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  workflow_dispatch:
    inputs:
      build_ios:
        description: 'Build iOS app'
        required: false
        default: 'true'
        type: boolean

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx3072m -Dorg.gradle.daemon=false -Dkotlin.incremental=false"

jobs:
  # Always run validation - it's fast and uses minimal minutes
  validation-and-android:
    name: Validation & Android Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      # Validation steps
      - name: Run KtLint Check
        run: ./gradlew ktlintCheck --info --stacktrace
        
      - name: Run Unit Tests (Shared)
        run: ./gradlew :composeApp:testDebugUnitTest --stacktrace
        
      # Android builds
      - name: Set keystore.properties from secret
        if: ${{ secrets.KEYSTORE_PROPERTIES }}
        run: echo "${{ secrets.KEYSTORE_PROPERTIES }}" | base64 --decode > keystore.properties
        
      - name: Build Android Debug APK
        run: ./gradlew :composeApp:assembleInternalDebug -Pbuildkonfig.flavor=internalDebug --stacktrace
        
      - name: Build Android Release APK
        run: ./gradlew :composeApp:assembleProductionRelease --stacktrace
        
      - name: Upload Android APKs
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: |
            composeApp/build/outputs/apk/internalDebug/*.apk
            composeApp/build/outputs/apk/productionRelease/*.apk
          retention-days: 14

  # iOS build - only runs on main branch pushes or manual trigger to save minutes
  ios-build:
    name: iOS Build (Limited)
    runs-on: macos-latest
    needs: validation-and-android
    # Only run iOS build on main branch or when manually triggered
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') || 
      (github.event_name == 'workflow_dispatch') ||
      (contains(github.event.pull_request.labels.*.name, 'test-ios'))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      # Aggressive caching to speed up builds
      - name: Cache Kotlin/Native compiler
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-konan-
            
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: iosApp/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-
            
      - name: Install CocoaPods
        run: gem install cocoapods
        
      # Build only what's essential
      - name: Build iOS Framework (Debug only to save time)
        run: ./gradlew :composeApp:linkDebugFrameworkIosX64 --stacktrace
          
      - name: Install iOS Dependencies
        run: |
          cd iosApp
          pod install
          
      - name: Build iOS Debug
        run: |
          cd iosApp
          xcodebuild -workspace iosApp.xcworkspace \
            -scheme iosApp \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.4' \
            -derivedDataPath build \
            build
            
      - name: Upload iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-debug-build
          path: iosApp/build/Build/Products/Debug-iphonesimulator/*.app
          retention-days: 7

  # Manual iOS Release build - only when you really need it
  ios-release:
    name: iOS Release Build (Manual Only)
    runs-on: macos-latest
    needs: validation-and-android
    # Only runs when manually triggered
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Cache Kotlin/Native compiler
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-konan-
            
      - name: Install CocoaPods
        run: gem install cocoapods
        
      - name: Build iOS Framework (Release)
        run: ./gradlew :composeApp:linkReleaseFrameworkIosX64 --stacktrace
          
      - name: Install iOS Dependencies
        run: |
          cd iosApp
          pod install
          
      - name: Build iOS Release
        run: |
          cd iosApp
          xcodebuild -workspace iosApp.xcworkspace \
            -scheme iosApp \
            -configuration Release \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.4' \
            -derivedDataPath build \
            build
            
      - name: Upload iOS Release Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-build
          path: iosApp/build/Build/Products/Release-iphonesimulator/*.app
          retention-days: 14